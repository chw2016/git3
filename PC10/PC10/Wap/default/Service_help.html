<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="{weikucms::STATICS}/wapweiui/service/css/default.css" type="text/css">
<script type="text/javascript" async="" src="{weikucms::STATICS}/wapweiui/service/js/ga.js"></script><script src="./车商通SCRM 15 点击救援_files/jquery-1.8.2.min.js"></script>
<script src="{weikucms::STATICS}/wapweiui/service/js/common.js"></script>

<meta charset="UTF-8">
<title>万普微盟</title>
<meta name="Keywords" content="万普微盟">
<meta content="yes" name="apple-mobile-web-app-capable">
<meta content="black" name="apple-mobile-web-app-status-bar-style">
<meta content="telephone=no" name="format-detection"> 
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" name="viewport" />
</head>



<body>
<script type="text/javascript" src="./车商通SCRM 15 点击救援_files/api"></script><script type="text/javascript" src="./车商通SCRM 15 点击救援_files/getscript"></script>
<script type="text/javascript" src="{weikucms::STATICS}/wapweiui/service/js/convertor.js"></script>

<div class="global_box" style="display:none;">
  <div class="tips_box_s"><span class="lbl">我的位置：</span><span class="D_F_Orange loc" id="span_geo" longitude="" latitude="" precision="">正在定位，请稍候...</span><span class="replace"><img src="./车商通SCRM 15 点击救援_files/refresh_img.png" width="15" height="15" onclick="baiduGetLocaltion();"></span></div>
</div>

<div class="failureRescue clearfix">
	<!-- 百度地图定位地图 -->
	<div class="mapWrap" style="display:none;">
		<div class="map" style="width:100%; height:200px;" id="showMap" destlong="114.075254" destlati="22.535617"></div>
		
		
	</div>
	<!-- 百度地图定位地图 -->
	<div class="title clearfix"><strong>救援电话</strong></div>
	<div class="telList clearfix">
		<ul>
			<li>
				<a href="tel:0755-83512494">
					<strong>24小时救援</strong>
					<span>0755-83512494</span>
					<i><img src="{weikucms::STATICS}/wapweiui/service/images/tell_01.png"></i>
				</a>
			</li>
			<li>
				<a href="tel:0755-83512494">
					<strong>厂家服务热线</strong>
					<span>0755-83512494</span>
					<i><img src="{weikucms::STATICS}/wapweiui/service/images/tell_01.png"></i>
				</a>
			</li>
			
<li>
				<a href="tel:122">
					<strong>联系交警</strong>
					<span>122</span>
					<i><img src="{weikucms::STATICS}/wapweiui/service/images/tell_01.png"></i>
				</a>
			</li>
		</ul>
	</div>
	
	<div class="title">我的保险公司</div>
	
	<div class="insurer">
		<div class="tell"><a href="javascript:void(0);" onclick="telNow($(this));"><img src="{weikucms::STATICS}/wapweiui/service/images/tell_01.png"></a></div>
		<div class="name">
			<select onchange="baoxin_change(this);" id="baoxinTel">
<option value="95518">中国人保 95518</option>
<option value="95519">中国人寿财险 95519</option>
<option value="95500">太平洋保险 95500</option>
<option value="95511">平安保险 95511</option>
<option value="95585">中华联合保险 95585</option>
<option value="95590">大地保险 95590</option>
<option value="95505">天安保险 95505</option>
<option value="96012345">大众保险 96012345</option>
<option value="95509">华泰保险 95509</option>
<option value="95502">永安保险 95502</option>
<option value="95556">华安保险 95556</option>
<option value="95569">安邦保险 95569</option>
<option value="95510">阳光保险 95510</option>
<option value="400-6995566">中银保险 400-6995566</option>
<option value="400-88-95586">都邦保险 400-88-95586</option>
<option value="4006-11-6666">渤海保险 4006-11-6666</option>
<option value="4008-600-600">众诚保险 4008-600-600</option>
<option value="95552">永城保险 95552</option>
<option value="4008-817-518">富邦财险 4008-817-518</option>
<option value="95589">太平保险 95589</option>
</select>
			<i></i>
		</div>
	</div>
</div>
<div id="back"><a href="javascript:window.location.href='javascript:window.history.back(-1);';"><img src="{weikucms::STATICS}/wapweiui/service/images/foot_back_android.png"></a></div>
<script type="text/javascript">
$(function(){
	if( browser.versions.iPhone )
	{
		$('#back a').attr('href',"index.php");
		$('#back a img').attr('src','http://i.16888.com/4/default/foot_back_ios.png');
	}
	else
	{
		$('#back a').attr('href',"javascript:window.location.href='/';");
		$('#back a img').attr('src','http://i.16888.com/4/default/foot_back_android.png');
	}
});
</script>


<script type="text/javascript">
document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
	//WeixinJSBridge.call('hideOptionMenu');
	WeixinJSBridge.call('hideToolbar');
});
</script>
<script type="text/javascript">
var _maq = _maq || [];
	_maq.push(['_setAccount', 1]);
	_maq.push(['_areaid', 49]);
	_maq.push(['_typeid', 2]);
	_maq.push(['_uid', 100047]);
	_maq.push(['_regtime', 1407047043]);
(function() {
	var ga = document.createElement('script');
	ga.type = 'text/javascript';
	ga.async = true;
	ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://log') + '.autoeo.com/ga.js';
	var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();
</script>
<!--<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>-->
<script type="text/javascript">
var getLocation_Loading = 0;
var locationAddress = '';//存储定位后的地址详情字符串

function baiduGetLocaltion(){
	if(getLocation_Loading){
		alert("正在定位，请稍候...");
		return false;
	}
	getLocation_Loading = 1;
	$("#span_geo").html("正在定位，请稍候...");
	$('.fault_box h1').remove();
	var geolocation = new BMap.Geolocation();
	geolocation.getCurrentPosition(function(r){
	    if(this.getStatus() == BMAP_STATUS_SUCCESS){
	        //alert('您的位置：'+r.point.lng+','+r.point.lat);
	    	convertor(r.point.lng, r.point.lat,1,0);
	    }
	    else {
			getLocation_Loading = 0;
			alert("定位失败，请重试！");
	    	$("#span_geo").html("定位失败，请重试！");
	    }
	},{enableHighAccuracy: true})
}

//坐标校准
var convertor=function(long,Lati,type,revise){
	//var xx = 116.397428;
	//var yy = 39.90923;
	if(revise)
	{
		var gpsPoint = new BMap.Point(long,Lati);
		//需要校准
		BMap.Convertor.translate(gpsPoint,0,function(point){
			//alert(point.lng + "," + point.lat);
			//获取地理位置信息
			getLocation(point.lng,point.lat,type);
		});
	}
	else
	{
		getLocation(long,Lati,type);
	}
};

//根据坐标获取地理位置信息
var getLocation=function(long,Lati,type){
	var point = new BMap.Point(long,Lati);
	var gc = new BMap.Geocoder();
	
	$.post(
		'index.php?mod=help&code=bdMapLocation',
		{long:long,lati:Lati},
		function(d){
			gc.getLocation(point, function(rs){
				var addComp = rs.addressComponents;
				
				if(type==1){
					//起点信息
					$("#span_geo").attr("longitude",long)
					$("#span_geo").attr("latitude",Lati);
					$("#span_geo").html(addComp.province + addComp.city + addComp.district + addComp.street + (addComp.streetNumber ? addComp.streetNumber : "") );
					if(!d.scope)
					{
						$('div[class="map"]').parent().after('<div class="button button_green"><a href="javascript:window.location.href=\'index.php?mod=help&code=nearby&long='+long+'&lat='+Lati+'\';" >一键救援</a></div>');
					}
					else
					{
						$('div[class="map"]').parent().after('<div class="button button_green"><a href="javascript:void(0);" onclick="clickForSupport('+long+','+Lati+');">一键救援</a></div>');
					}
					getLocation_Loading = 0;
					
					p1 = {'long':long,lati:Lati};//起点
					drawMap(p1,'showMap');
				}
			});
		},
		'json'
	);
};

var telNow = function(dom){
	telSelected = $("#baoxinTel").val();
	if(telSelected)
	{
		dom.attr('href','tel:'+telSelected);
		return true;
	}
	else
	{
		return false;
	}
};

$(window).load(function(){
	longitude = $("#span_geo").attr("longitude"); 
	latitude = $("#span_geo").attr("latitude"); 
	if(!parseInt(longitude) || !parseInt(latitude)){
		baiduGetLocaltion();
		//p1 = {'long':'114.076364',lati:'22.533987','txt':"您在这里哦！"};//起点
		//drawMap(p1,'showMap');
	}
	else{
		convertor(longitude,latitude,1,1);
	}
});

var clickAirplane = function(){
	$('#showMap').siblings(".locate").click(function(){
		msgcontent = $('#showMap').siblings(".locate").attr('locationdescription');
		showAlert2('是否发送地理位置：','您的位置是："'+msgcontent+'"<br />是否确定要向我们发送求救信号？',{'sureFun':'sendLocationMsg','sureTitle':'确认发送','cancelFun':'closeAlert','cancelTitle':'取消'});
		return;
	});
}

//点击后跳转到百度导航
var sendLocationMsgLoading = 0;
var sendLocationMsg = function(){
	closeAlert();
	if(sendLocationMsgLoading=='success'){
		show_success_tip("地理位置已发送成功<br />请等待救援");
		return false;
	}
	
	if(sendLocationMsgLoading){
		show_success_tip("正在发送。。。");
		return false;
	}
	slong = $("#span_geo").attr("longitude");
	slati = $("#span_geo").attr("latitude");
	msgcontent = $('#showMap').siblings(".locate").attr('locationdescription');
	msgcontent = '奥迪A6  车主  多了  (粤B12345) 发来救援，联系电话：，地址：'+msgcontent;
	//msgcontent += ""+;
	sendLocationMsgLoading = 1;
	$.post('ajax.php?mod=set&code=addaftermsg', {'uid':'100047','u_name':'多了','content':msgcontent}, function(d){
		if(d.status==1){
			show_success_tip("您的求救信号我们已收到<br />我们将在跟您确认后火速赶到现场。");
			sendLocationMsgLoading = 'success';
		}
		else{
			show_error_tip("发送失败");
			sendLocationMsgLoading = 0;
		}
	},'json');
}

var drawMap = function(p1,container){
	if(container){
		$('#'+container).parent('div').show();
		clickAirplane();
	}
	var map = new BMap.Map(container);
	point1 = new BMap.Point(p1.long,p1.lati);
	map.centerAndZoom(point1, 15);
	
	var marker1 = new BMap.Marker(point1);  // 创建标注
	map.addOverlay(marker1);              // 将标注添加到地图中

	//获取位置信息
	var getLoc = new BMap.Geocoder();   
	getLoc.getLocation(point1, function(rs){
        var addComp = rs.addressComponents;
	
		//地址详情字符串
		locationAddress = addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber;
		
		//创建信息窗口，显示地址详情
		var infoWindow1 = new BMap.InfoWindow(locationAddress);
		
		//给指定元素的属性赋值
		$('#showMap').siblings(".locate").attr('locationDescription',locationAddress);
		
		//点击后显示位置信息
		marker1.addEventListener("click", function(){this.openInfoWindow(infoWindow1);});
		
		//直接显示位置信息
		marker1.openInfoWindow(infoWindow1);
    });
	map.enableScrollWheelZoom();    //启用滚轮放大缩小，默认禁用
	//map.enableContinuousZoom();    //启用地图惯性拖拽，默认禁用
}
var isNeedNamePhone = 1;
var clickForSupport = function(long,lati)
{
	if(isNeedNamePhone)
	{
		content = '';
		content +='<div class="failureRescueTitle">';
		content +='<h2 class="green">请输入您的手机号</h2>';
		content +='<p>救援师傅会在第一时间与您联系</p>';
		content +='</div>';
		content +='<div class="inputList">';
		content +='<ul>';
		content +='<li><input class="input" name="uname" placeholder="请输入姓名" value="多了"></li>';
		content +='	</ul>';
		content +='</div>';
		content +='<div class="inputList">';
		content +='<ul>';
		content +='<li><input class="input" name="uphone" placeholder="请输入电话号码" value=""></li>';
		content +='</ul>';
		content +='</div>';
		content +='<div class="button"><a href="javascript:void(0);" onclick="sendSupport('+long+','+lati+');">发出救援</a></div>';
		
		global_show_info(content,'left', '');
	}
	else
	{
		sendSupport(long,lati);
	}
}
var send_support_loading = 0;
var sendSupport = function(long,lati)
{
	if(send_support_loading) 
	{
		show_success_tip('正在提交，请稍后');
		return false;
	}
	
	params = {};
	if(isNeedNamePhone)
	{
		uname = $('input[name="uname"]').val();
		uphone= $('input[name="uphone"]').val();
		if( uname=='' || uphone=='' )
		{
			show_error_tip('姓名、电话不能为空');
			return false;
		}
		else
		{
			if(!checkName(uname))
			{
				show_error_tip('姓名请输入<br />至少2位中文字符');
				return false;
			}
			
			if(!checkPhone(uphone))
			{
				show_error_tip('请填写正确的联系电话');
				return false;
			}
		}
		
		params.uname = uname;
		params.uphone= uphone;
	}
	
	params.long = long;
	params.lati = lati;
	params.address = locationAddress;
	
	send_support_loading = 1;
	$.post(
		'/ajax.php?mod=user&code=sendSupport',
		params,
		function(res)
		{
			if(res.ret)
			{
				window.location.href= '/index.php?mod=help&code=support&sid='+res.data;
			}
			else
			{
				show_success_tip('网络阻塞，插入失败<br />请稍后再试');
				send_support_loading = 0;
				return false;
			}
		},
		'json'
	);
	
}
</script></body></html>